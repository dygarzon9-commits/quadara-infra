name: CI - Build backend images

on:
  push:
    branches: [ "main" ]
    paths:
      - "backend/**"
      - ".github/workflows/ci-build.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-backend:
    runs-on: ubuntu-latest

    env:
      ACR_NAME: ${{ secrets.ACR_NAME }}
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Login con Service Principal usando AZURE_CREDENTIALS
      - name: Login to Azure (service principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Debug repo structure
        run: |
          echo "=== ROOT ==="
          ls -la
          echo "=== BACKEND ==="
          ls -la backend
          echo "=== AUTH ==="
          ls -la backend/auth-service
        
      - name: Validate ACR_NAME
        run: |
          if [ -z "${ACR_NAME}" ]; then
            echo "❌ ACR_NAME no está definido en secrets."
            exit 1
          fi
          echo "✅ ACR_NAME=${ACR_NAME}"

      - name: Build images into ACR
        run: |
          for svc in auth-service device-management-service monitoring-service; do
            echo "⏳ Building image for: $svc"
            az acr build -r "$ACR_NAME" \
               -t "$svc:latest" \
               -f "$svc/Dockerfile" \
               backend
            echo "✅ Built $svc"
          done
